<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Scanarium</title>
    <!--
        The below phaser file can be fetched from
        https://cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js
        -->
    <script src="phaser-3.11.0.js"></script>

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <style type="text/css">
        body {
            margin: 0;
            background-color: black;
        }
    </style>
</head>
<body>

<script type="text/javascript">
function parseUrlParameters()
{
    var parameters=new Object();
    var query = window.location.href.replace(/^[^?]*\?/,'');
    if ( window.location.href == query )
    {
        query = "";
    }

    var kvs = query.split('&');

    for ( index in kvs)
    {
        var key = decodeURIComponent(kvs[index].replace(/^([a-zA-Z0-9_]*)=.*/,"\$1"));
        if ( key != kvs[index] )
        {
            var value = decodeURIComponent(kvs[index].replace(/^([a-zA-Z0-9_]*)=/,""));
            parameters[key]=value;
        }
    }
    return parameters;
}
var parameters = parseUrlParameters();

var localization = {};
var formatTemplate = function(string, parameters) {
    split = string.split('{');
    for (i=1; i<split.length; i++) {
        closingIdx = split[i].indexOf('}');
        if (closingIdx != -1) {
            param_name = split[i].substring(0, closingIdx);
            rest = split[i].substring(closingIdx+1);
            param_value = parameters[param_name];
            split[i] = param_value + rest;
        } else {
            split[i] = '{' + split[i];
        }
    }
    return split.join('');
}

var localize_parameter = function(name, value) {
    all_parameter_localizations = localization['parameters'] || {};
    key_localizations = all_parameter_localizations[name] || {};
    return key_localizations[value] || value;
}

var localize = function(template, parameters) {
    localized_parameters = {};
    Object.keys(parameters || {}).forEach((key, index) => {
        localized_parameters[key] = localize_parameter(key, parameters[key]);
    });
    message_localizations = localization['messages'] || {};
    template = message_localizations[template] || template;
    return formatTemplate(template, localized_parameters);
};

</script>

<script src="scanarium.js"></script>

<script type="text/javascript">
var language = getParameter('language', '').split(/[;,.-_]/)[0].toLowerCase();
if (language) {
  loadJson('localization/' + language + '.json', function(data) {
    localization = data;
  });
}

var cgis = {
  ' ': 'scan',
  's': 'show-source',
  'r': 'reindex'
};

var cgiFail = function(uuid, cgi, reason) {
  var msg = localize('{cgi_name} failed', {'cgi_name': cgi});
  msg += ': ' + localize(reason);
  MessageManager.addMessage(uuid, 'failed', msg);
};

var cgiOk = function(uuid, cgi, payload) {
  var suffix = '';
  var msg = localize('{cgi_name} ok', {'cgi_name': cgi});
  if (cgi == 'scan') {
    var sanitized_scene = sanitize_string(payload, 'scene');
    var sanitized_actor = sanitize_string(payload, 'actor');
    var sanitized_flavor = sanitize_string(payload, 'flavor');
    var scan_msg = 'Scanned new actor drawing for {actor_name}';
    if (sanitized_scene == scene) {
      if (typeof ScActorManager !== 'undefined') {
        ScActorManager.addActor(sanitized_actor, sanitized_flavor);
      }
    } else {
      scan_msg += ' for scene {scene_name}';
    }
    msg += ': ' + localize(scan_msg);
  }
  MessageManager.addMessage(uuid, 'ok', msg);
};

var onReadyStateChange = function(cgi) {
  return function() {
    if (this.readyState === XMLHttpRequest.DONE) {
      if (this.status == 200) {
        var capsule = JSON.parse(this.responseText);
        var uuid = sanitize_string(capsule, 'uuid');
        if (sanitize_boolean(capsule, 'is_ok')) {
          cgiOk(uuid, cgi, sanitize_dictionary(capsule, 'payload'));
        } else {
          cgiFail(uuid, cgi, sanitize_string(capsule, 'error_message'));
        }
      } else {
        cgiFail(null, cgi, 'Response status was ' + this.status + ' instead of 200');
      }
    }
  };
};

document.addEventListener("keypress", function(e) {
  if (e.key === 'f') {
    canvases = document.getElementsByTagName('canvas');
    if (canvases.length) {
      canvases[0].requestFullscreen();
    }
  } else if (e.key === 'p') {
    // We (un)pause outside of the game itself, as a paused game did not handle
    // keydown events reliable and hence made it tricky to unpause.
    scanariumConfig.paused = !scanariumConfig.paused;
    if (scanariumConfig.paused) {
      game.scene.pause();
    } else {
      game.scene.resume();
    }
  } else if (e.key === '?') {
    // Phaser does not offer a keycode for question mark, so we trigger from
    // outside.
    HelpPage.toggleVisibility();
  } else if (e.key in cgis) {
    var cgi = cgis[e.key];
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'cgi-bin/' + cgi, true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.onreadystatechange = onReadyStateChange(cgi);
    xhr.send();
  }
}, false);
</script>

</body>
</html>
