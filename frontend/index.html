<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Scanarium</title>
    <!--
        The below phaser file can be fetched from
        https://cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js
        -->
    <script src="phaser-3.11.0.js"></script>

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <style type="text/css">
        body {
            margin: 0;
            background-color: black;
        }
    </style>
</head>
<body>

<script type="text/javascript">
function parseUrlParameters()
{
    var parameters=new Object();
    var query = window.location.href.replace(/^[^?]*\?/,'');
    if ( window.location.href == query )
    {
        query = "";
    }

    var kvs = query.split('&');

    for ( index in kvs)
    {
        var key = decodeURIComponent(kvs[index].replace(/^([a-zA-Z0-9_]*)=.*/,"\$1"));
        if ( key != kvs[index] )
        {
            var value = decodeURIComponent(kvs[index].replace(/^([a-zA-Z0-9_]*)=/,""));
            parameters[key]=value;
        }
    }
    return parameters;
}
var parameters = parseUrlParameters();
</script>

<script src="scanarium.js"></script>

<script type="text/javascript">
var cgis = {
  ' ': 'scan',
  's': 'show-source',
  'r': 'reindex'
};

var cgiFail = function(cgi, reason) {
  MessageManager.addMessage('failed', cgi + ' failed: ' + reason);
};

var cgiOk = function(cgi, payload) {
  var suffix = '';
  if (cgi == 'scan') {
    var sanitized_scene = sanitize(payload.scene);
    var sanitized_actor = sanitize(payload.actor);
    var sanitized_flavor = sanitize(payload.flavor);
    if (sanitized_scene == scene) {
      if (typeof ScActorManager !== 'undefined') {
        ScActorManager.addActor(sanitized_actor, sanitized_flavor);
      }
    } else {
      suffix = ', but actor cannot be used, as it is for scene "' + sanitized_scene + '" while we are playing scene "' + scene + '"';
    }
  }
  MessageManager.addMessage('ok', cgi + ' ok' + suffix);
};

var onReadyStateChange = function(cgi) {
  return function() {
    if (this.readyState === XMLHttpRequest.DONE) {
      if (this.status == 200) {
        var capsule = JSON.parse(this.responseText);
        if (capsule.is_ok) {
          cgiOk(cgi, capsule.payload);
        } else {
          cgiFail(cgi, sanitize(capsule.error_message));
        }
      } else {
        cgiFail(cgi, 'Response status was ' + this.status + ' instead of 200');
      }
    }
  };
};

document.addEventListener("keypress", function(e) {
  if (e.key === 'f') {
    canvases = document.getElementsByTagName('canvas');
    if (canvases.length) {
      canvases[0].requestFullscreen();
    }
  } else if (e.key === 'p') {
    // We (un)pause outside of the game itself, as a paused game did not handle
    // keydown events reliable and hence made it tricky to unpause.
    scanariumConfig.paused = !scanariumConfig.paused;
    if (scanariumConfig.paused) {
      game.scene.pause();
    } else {
      game.scene.resume();
    }
  } else if (e.key === '?') {
    // Phaser does not offer a keycode for question mark, so we trigger from
    // outside.
    HelpPage.toggleVisibility();
  } else if (e.key in cgis) {
    var cgi = cgis[e.key];
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'cgi-bin/' + cgi, true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.onreadystatechange = onReadyStateChange(cgi);
    xhr.send();
  }
}, false);
</script>

</body>
</html>
